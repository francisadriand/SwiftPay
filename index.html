<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftPay Test</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <a href="index.html">SwiftPay</a>
        <a href="transactionlogs.html">Transaction Logs</a>
    </header>

    <div class="main-container">
        <h1>SwiftPay Accounts</h1>
        
        <table id="accountsTable">
            <thead>
                <tr>
                    <th class="table-headers">Account Number</th>
                    <th class="table-headers">Account Name</th>
                    <th class="table-headers">Balance</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <div class="phases">
            <div class="phaseTables">
                <form id="form-phase1">
                    <h2>Basic Transfer (Phase 1)</h2>
                    <label for="sender1">Sender: </label>
                    <input type="text" placeholder="Enter account number" id="sender1" name="sender" required><br><br>
                    <label for="receiver1">Receiver: </label>
                    <input type="text" placeholder="Enter account number" id="receiver1" name="receiver" required><br><br>
                    <label for="amount1">Amount: </label>
                    <input type="number" placeholder="Enter amount" id="amount1" name="amount" step="0.01" required><br><br>
                    <button type="submit">Transfer</button>
                </form>
            </div>

            <div class="phaseTables">
                <form id="form-phase2">
                    <h2>Advanced Transfer (Phase 2)</h2>
                    <label for="sender2">Sender: </label>
                    <input type="text" placeholder="Enter account number" id="sender2" name="sender" required><br><br>
                    <label for="receiver2">Receiver: </label>
                    <input type="text" placeholder="Enter account number" id="receiver2" name="receiver" required><br><br>
                    <label for="amount2">Amount: </label>
                    <input type="number" placeholder="Enter amount" id="amount2" name="amount" step="0.01" required><br><br>
                    <button type="submit">Transfer</button>
                </form>
            </div>

            <div class="phaseTables">
                <form id="form-phase3">
                    <h2>Transfer With Bonus (Phase 3)</h2>
                    <label for="sender3">Sender: </label>
                    <input type="text" placeholder="Enter account number" id="sender3" name="sender" required><br><br>
                    <label for="receiver3">Receiver: </label>
                    <input type="text" placeholder="Enter account number" id="receiver3" name="receiver" required><br><br>
                    <label for="amount3">Amount: </label>
                    <input type="number" placeholder="Enter amount" id="amount3" name="amount" step="0.01" required><br><br>
                    <button type="submit">Transfer</button>
                </form>
            </div>
        </div>
    </div>

    <input type="text" id="message" placeholder="Message...">
    <button id="saveBtn">Save</button>

    <footer>
        <p>&copy; 2024 SwiftPay. All rights reserved.</p>
    </footer>

    <script type="module">
        // 1. Import App and Firestore initialization functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, getDocs, collection, doc, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. IMPORTANT: Paste your actual Firebase Config here
        const firebaseConfig = {
            apiKey: "AIzaSyATGDinwBxUwZO8gkhmtzvoxTDAmFn1-hI",
            authDomain: "my-sample-cc95a.firebaseapp.com",
            projectId: "my-sample-cc95a",
            storageBucket: "my-sample-cc95a.firebasestorage.app",
            messagingSenderId: "987232941668",
            appId: "987232941668:web:a4d9bd525713db969d5171"
        };

        // 3. Initialize Firebase and Firestore
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DISPLAY ACCOUNTS ---
        async function displayAccounts() {
            const tbody = document.querySelector("#accountsTable tbody");
            tbody.innerHTML = ""; // Clear existing rows so they don't duplicate on refresh

            try {
                const querySnapshot = await getDocs(collection(db, "accounts"));
                querySnapshot.forEach((doc) => {
                    const account = doc.data();
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = doc.id;
                    row.insertCell(1).textContent = account.AccountName;
                    row.insertCell(2).textContent = "$" + account.Balance.toFixed(2);
                });
            } catch (error) {
                console.error("Error fetching documents: ", error);
            }
        }

        // Call immediately on page load
        displayAccounts();

        // --- TRANSACTIONS ---
        async function basicTransfer(sender, receiver, amount) {
            const senderRef = doc(db, "accounts", sender);
            const receiverRef = doc(db, "accounts", receiver);

            await runTransaction(db, async (transaction) => {
                const senderDoc = await transaction.get(senderRef);
                const receiverDoc = await transaction.get(receiverRef);

                if (!senderDoc.exists() || !receiverDoc.exists()) throw "Invalid account.";

                const senderBalance = senderDoc.data().Balance;
                const receiverBalance = receiverDoc.data().Balance;

                transaction.update(senderRef, { Balance: senderBalance - amount });
                transaction.update(receiverRef, { Balance: receiverBalance + amount });
            });
            alert("Transfer successful!");
        }

        async function transferWithCheck(sender, receiver, amount) {
            const senderRef = doc(db, "accounts", sender);
            const receiverRef = doc(db, "accounts", receiver);

            try {
                await runTransaction(db, async (transaction) => {
                    const senderDoc = await transaction.get(senderRef);
                    const receiverDoc = await transaction.get(receiverRef);

                    if (!senderDoc.exists() || !receiverDoc.exists()) throw "Invalid account.";
                    const senderBalance = senderDoc.data().Balance;
                    if (senderBalance < amount) throw "Insufficient balance.";

                    transaction.update(senderRef, { Balance: senderBalance - amount });
                    transaction.update(receiverRef, { Balance: receiverDoc.data().Balance + amount });
                });
                alert("Transfer successful!");
            } catch (error) {
                alert(error);
            }
        }

        async function transferWithBonus(sender, receiver, amount) {
            const senderRef = doc(db, "accounts", sender);
            const receiverRef = doc(db, "accounts", receiver);

            try {
                await runTransaction(db, async (transaction) => {
                    const senderDoc = await transaction.get(senderRef);
                    const receiverDoc = await transaction.get(receiverRef);

                    if (!senderDoc.exists() || !receiverDoc.exists()) throw "Invalid account.";
                    const senderBalance = senderDoc.data().Balance;
                    if (senderBalance < amount) throw "Insufficient balance.";

                    const bonus = amount * 0.05;
                    transaction.update(senderRef, { Balance: senderBalance - amount });
                    transaction.update(receiverRef, { Balance: receiverDoc.data().Balance + amount + bonus });
                });
                alert("Transfer successful with bonus!");
            } catch (error) {
                alert(error);
            }
        }

        // --- EVENT LISTENERS FOR FORMS ---
        // This attaches the JS functions to the forms without submitting to PHP
        
        function handleFormSubmit(formId, transferFunction) {
            document.getElementById(formId).addEventListener("submit", async (e) => {
                e.preventDefault(); // Prevents page reload / going to index.php
                const sender = e.target.sender.value;
                const receiver = e.target.receiver.value;
                const amount = parseFloat(e.target.amount.value);
                
                await transferFunction(sender, receiver, amount);
                displayAccounts(); // Refresh the table automatically
                e.target.reset(); // Clear the form inputs
            });
        }

        handleFormSubmit("form-phase1", basicTransfer);
        handleFormSubmit("form-phase2", transferWithCheck);
        handleFormSubmit("form-phase3", transferWithBonus);

    </script>
</body>
</html>